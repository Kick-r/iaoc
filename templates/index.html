<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Orb</title>

    <style>
        :root {
            --bg: #dce2ee;
            --ver: #a11a32;
            --primary: #caa5cb;
            --dark: #24272c;
            --white: #f2f3f9;
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            display: flex;
            height: 100vh;
            color: var(--dark);
        }

        .sidebar {
            width: 14vw;
            background: var(--white);
            padding: 24px;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .sidebar h1 {
            font-size: 18px;
            margin-bottom: 12px;
        }

        .chat {
            width: 86vw;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 3.5em 6px 24px 24px;
        }

        .messages {
            position: relative;
            flex: 1;
            overflow-y: auto;
            padding-right: 12px;
        }

        .msg {
            width: fit-content;
            max-width: 55%;
            word-wrap: break-word;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 16px;
            line-height: 1.4;
        }

        .msg.user {
            background: var(--ver);
            color: white;
            margin-left: auto;
        }

        .msg.bot {
            background: #24272c;
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: white;
        }

        .input-area {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            align-items: center;
            justify-content: center;
        }

        .input-area input {
            width: 70em;
            padding: 14px 16px;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--ver);
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h1>Maggie</h1>
        <p>PresenÃ§a ativa</p>
    </div>

    <div class="chat">
        <div class="messages" id="messages"></div>

        <div class="input-area">
            <input id="msgInput" type="text" placeholder="Escreve aÃ­â€¦" />
            <button id="sendBtn" class="send">âž¤</button>
        </div>
    </div>

    <script>
        const messagesEl = document.getElementById("messages");
        const inputEl = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");

        let audioQueue = [];
        let playing = false;

        function addMsg(role, html) {
            const div = document.createElement("div");
            div.className = "msg " + role;

            if (role === "bot") {
                div.innerHTML = html; // Maggie manda HTML
            } else {
                div.textContent = html;
            }

            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function playNextAudio() {
            if (playing || audioQueue.length === 0) return;

            playing = true;
            const item = audioQueue.shift();

            try {
                const audio = new Audio(item.url);
                await audio.play();

                audio.addEventListener("ended", async () => {
                    playing = false;
                    try {
                        await fetch(item.deleteUrl, { method: "DELETE" });
                    } catch { }
                    playNextAudio();
                });

            } catch {
                playing = false;
            }
        }

        async function enviar() {
            const text = inputEl.value.trim();
            if (!text) return;

            addMsg("user", text);
            inputEl.value = "";

            const typing = document.createElement("div");
            typing.className = "msg bot";
            typing.innerHTML = "<i>Maggie tÃ¡ pensandoâ€¦</i>";
            messagesEl.appendChild(typing);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: text })
                });

                const data = await res.json();
                typing.remove();

                addMsg("bot", data.text);

                if (data.audio) {
                    const nome = data.audio.split("/").pop();
                    audioQueue.push({
                        url: data.audio,
                        deleteUrl: `/audio/${nome}/delete`
                    });
                    playNextAudio();
                }

            } catch {
                typing.remove();
                addMsg("bot", "<i>Erro ao conectar com o servidor ðŸ˜”</i>");
            }
        }

        sendBtn.addEventListener("click", enviar);
        inputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") enviar();
        });

        // Mensagem inicial
        addMsg("bot",
            "<b>Oi! Eu sou a Maggie ðŸ˜Š</b><br>" +
            "Me conta: o que tÃ¡ te deixando mais perdido agora?"
        );
    </script>
</body>

</html>
